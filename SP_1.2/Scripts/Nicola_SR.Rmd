---
title: "Nicola S-R"
author: "Colin Bailey"
date: "2025-04-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

here::here()

library(dplyr)
library(tidyverse)
library(rstan)
library(shinystan)
library(bayesplot)
library(pkgbuild)
library(boot)
library(loo)
library(MASS)
#install.packages("remotes")    #run this line and the next once to get access to the sgen solver that DFO has developed
#remotes::install_github("Pacific-salmon-assess/samSim")  
library(samSim) #package that DFO created with the sgen solver to estimate sgen given stock recruit parameters

pkgbuild::has_build_tools(debug = TRUE)

rstan_options(auto_write=T)

options(mc.cores = parallel::detectCores())

nic_dat <- read.csv("Data_in//nic_dat.csv")
head(nic_dat)
```


```{r data vis}

nic_dat %>% ggplot(aes(x = brood_year, y = log(wild_recruits/total_spawners)))+
  geom_point()+
  theme_classic()


```


```{r ricker model}

#creating the list of data to feed to Stan
dat <- list("N" = nrow(nic_dat),                  #number of years of data
            "surv" = nic_dat$smolt_age3_survival, #logit-transformed smolt to age 3 adult survival
            "lrs" = pull(nic_dat %>% mutate(lrs = log(wild_recruits/total_spawners)) %>% dplyr::select(lrs)),  #log natural origin recruits per spawner (HO & NO)
            "S" = nic_dat$total_spawners, #vector of total spawner abundance
            "mlogit_surv" = mean(nic_dat$smolt_age3_survival)) #mean logit-transformed survival

#running the Stan model
fit <- stan(file = "Scripts/Ricker.stan", data = dat, chains=6,
                    iter=10000, cores=6, thin = 1,
                    control=list("max_treedepth"=15,"adapt_delta"=0.8),
                    pars=c("beta", "alpha", "gamma", "sigma", "nu_Y", "mu_gamma_Y", "nu_rec", "srep", "smsy_85", "smsy", "umsy"))

#fit summary
out <- summary(fit)
saveRDS(out, "Results/out.rds")

#running the Stan model with RW
fit_rw <- stan(file = "Scripts/Ricker_rw.stan", data = dat, chains=6,
                    iter=10000, cores=6, thin = 1,
                    control=list("max_treedepth"=15,"adapt_delta"=0.8),
                    pars=c("beta", "alpha", "sigma", "nu_Y", "nu_rec", "srep", "smsy_85", "smsy", "umsy"))

#fit summary
out_rw <- summary(fit_rw)
saveRDS(out_rw, "Results/out_rw.rds")

```


```{r results vis}

mlogit_surv <- mean(nic_dat$smolt_age3_survival)

ricker <- function(x){
  (out$summary[1,1] * x + out$summary[3,1] * mlogit_surv + out$summary[2,1])
}

ricker_exp <- function(x){
  exp(out$summary[1,1] * x + out$summary[3,1] * mlogit_surv + out$summary[2,1]) * x
}

nic_dat %>% ggplot(aes(x = total_spawners, y = log(wild_recruits/total_spawners)))+
  geom_point()+
  geom_function(fun = ricker)+
  theme_classic()

nic_dat %>% ggplot(aes(x = total_spawners, y = wild_recruits))+
  geom_point()+
  geom_function(fun = ricker_exp)+
  theme_classic()

ricker_rw <- function(x){
  (out_rw$summary[1,1] * x + out_rw$summary[2,1])
}

ricker_exp_rw <- function(x){
  exp(out_rw$summary[1,1] * x + out_rw$summary[2,1]) * x
}

nic_dat %>% ggplot(aes(x = total_spawners, y = log(wild_recruits/total_spawners)))+
  geom_point()+
  geom_function(fun = ricker_rw)+
  theme_classic()

nic_dat %>% ggplot(aes(x = total_spawners, y = wild_recruits))+
  geom_point()+
  geom_function(fun = ricker_exp_rw)+
  theme_classic()

```